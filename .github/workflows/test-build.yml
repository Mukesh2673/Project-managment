name: Test Build & Migrations

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-build:
    name: Test Production Build
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: testdb
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for MySQL
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -u root -ptestpassword --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: Run migrations
        run: npm run migrate
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: root
          DB_PASSWORD: testpassword
          DB_NAME: testdb
          NODE_ENV: test

      - name: Build application
        run: npm run build
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: root
          DB_PASSWORD: testpassword
          DB_NAME: testdb
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: Verify build artifacts
        run: |
          if [ ! -d ".next" ]; then
            echo "❌ Build failed: .next directory not found"
            exit 1
          fi
          echo "✓ Build artifacts created successfully"
          
          # Check for key build files
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "⚠️  Warning: BUILD_ID not found"
          else
            echo "✓ Build ID generated"
          fi

      - name: Check migration status
        run: |
          mysql -h 127.0.0.1 -u root -ptestpassword testdb -e "SELECT * FROM migrations;" || echo "Migrations table check skipped"
